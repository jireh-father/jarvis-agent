name: Auto Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  code-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: AI Code Review
      uses: anc95/ChatGPT-CodeReview@main
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      with:
        model: gpt-4
        language: ko
        
    - name: Add review comment
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const { data: pr } = await github.rest.pulls.get({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: context.issue.number,
          });
          
          const comment = `## ğŸ¤– ìë™ ì½”ë“œ ë¦¬ë·°

          PRì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤! ë‹¤ìŒ ì‚¬í•­ì„ í™•ì¸í•´ì£¼ì„¸ìš”:

          ### ì²´í¬ë¦¬ìŠ¤íŠ¸
          - [ ] í…ŒìŠ¤íŠ¸ê°€ í†µê³¼í•˜ëŠ”ì§€ í™•ì¸
          - [ ] ì½”ë“œ ìŠ¤íƒ€ì¼ ê°€ì´ë“œë¥¼ ì¤€ìˆ˜í•˜ëŠ”ì§€ í™•ì¸
          - [ ] ë¬¸ì„œê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆëŠ”ì§€ í™•ì¸
          - [ ] Breaking changesê°€ ìˆëŠ”ì§€ í™•ì¸

          ### ë³€ê²½ ì‚¬í•­
          - **Files changed**: ${pr.changed_files}ê°œ
          - **Additions**: +${pr.additions}
          - **Deletions**: -${pr.deletions}

          ë¦¬ë·°ì–´ ë¶„ë“¤ê»˜ì„œ ê²€í†  ë¶€íƒë“œë¦½ë‹ˆë‹¤! ğŸ‘€`;
          
          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
            body: comment
          });

