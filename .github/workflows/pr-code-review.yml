name: Auto Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  code-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: AI Code Review
      uses: anc95/ChatGPT-CodeReview@main
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      with:
        model: gpt-4
        language: ko
        
    - name: Add review comment
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const { data: pr } = await github.rest.pulls.get({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: context.issue.number,
          });
          
          const comment = `## 🤖 자동 코드 리뷰

          PR이 생성되었습니다! 다음 사항을 확인해주세요:

          ### 체크리스트
          - [ ] 테스트가 통과하는지 확인
          - [ ] 코드 스타일 가이드를 준수하는지 확인
          - [ ] 문서가 업데이트되었는지 확인
          - [ ] Breaking changes가 있는지 확인

          ### 변경 사항
          - **Files changed**: ${pr.changed_files}개
          - **Additions**: +${pr.additions}
          - **Deletions**: -${pr.deletions}

          리뷰어 분들께서 검토 부탁드립니다! 👀`;
          
          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
            body: comment
          });

